{"version":3,"file":"locationService.js","sources":["src/services/locationService.ts"],"sourceRoot":"/","sourcesContent":["import { firestoreDb } from \"../lib/firebase.js\";\nimport type { Location } from \"../models/location.js\";\n\n// Helper to get collection reference\nfunction getLocationsCollection(userId: string) {\n  return firestoreDb.collection(`users/${userId}/locations`);\n}\n\n// No need for getFirestore; using firestoreDb from admin SDK\n\nexport async function fetchLatestLocation(\n  userId: string\n): Promise<Location | null> {\n  const locationsRef = getLocationsCollection(userId);\n  const snapshot = await locationsRef.orderBy(\"ts\", \"desc\").limit(1).get();\n  if (snapshot.empty || !snapshot.docs[0]) return null;\n  return snapshot.docs[0].data() as Location;\n}\n\nexport async function fetchLocationHistory(\n  userId: string\n): Promise<Location[]> {\n  const locationsRef = getLocationsCollection(userId);\n  const snapshot = await locationsRef.orderBy(\"ts\", \"desc\").get();\n  return snapshot.docs.map((doc) => doc.data() as Location);\n}\n\nexport async function fetchAllUsersLatestLocations(): Promise<\n  Array<{\n    userId: string;\n    location: Location;\n    userName?: string;\n  }>\n> {\n  try {\n    // Get all users from the main users collection\n    const usersRef = firestoreDb.collection(\"users\");\n    const usersSnapshot = await usersRef.get();\n\n    const allLocations: Array<{\n      userId: string;\n      location: Location;\n      userName?: string;\n    }> = [];\n\n    // For each user, get their latest location\n    for (const userDoc of usersSnapshot.docs) {\n      const userId = userDoc.id;\n      const userData = userDoc.data();\n      const latestLocation = await fetchLatestLocation(userId);\n\n      if (latestLocation) {\n        allLocations.push({\n          userId,\n          location: latestLocation,\n          userName: userData.firstName\n            ? `${userData.firstName} ${userData.lastName || \"\"}`\n            : userId,\n        });\n      }\n    }\n\n    return allLocations;\n  } catch (err) {\n    console.error(\"Error fetching all users locations:\", err);\n    return [];\n  }\n}\n\nexport function validateLocationPayload(\n  payload: Partial<Location>\n): string | null {\n  if (\n    !payload.coords ||\n    typeof payload.coords.lat !== \"number\" ||\n    typeof payload.coords.lng !== \"number\"\n  ) {\n    return \"Missing or invalid coordinates\";\n  }\n  return null;\n}\n\nexport async function saveUserLocation(\n  userId: string,\n  coords: Location[\"coords\"],\n  device?: Location[\"device\"]\n): Promise<boolean> {\n  const payload: Location = {\n    uid: userId,\n    ts: new Date(),\n    coords,\n    device: device || {},\n  };\n  const locationsRef = getLocationsCollection(userId);\n  const docId = Date.now().toString();\n  await locationsRef.doc(docId).set(payload);\n  return true;\n}\n"],"names":[],"mappings":"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","debug_id":"a7e0f227-7e31-5244-8430-82ac689db331"}