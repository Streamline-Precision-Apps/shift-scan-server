{"version":3,"file":"locationService.js","sources":["src/services/locationService.ts"],"sourceRoot":"/","sourcesContent":["import prisma from \"../lib/prisma.js\";\nimport type { Location } from \"../types/Location.js\";\n\nexport async function fetchLatestLocation(\n  userId: string\n): Promise<Location | null> {\n  const marker = await prisma.locationMarker.findFirst({\n    where: {\n      Session: {\n        userId,\n      },\n    },\n    orderBy: {\n      createdAt: \"desc\",\n    },\n  });\n\n  if (!marker) {\n    console.warn(`[Location] No location found for user ${userId}`);\n    return null;\n  }\n\n  console.log(`[Location] Fetching latest for user ${userId}: location found`);\n\n  return {\n    uid: userId,\n    ts: marker.createdAt,\n    coords: {\n      lat: marker.lat,\n      lng: marker.long,\n      accuracy: marker.accuracy,\n      speed: marker.speed,\n      heading: marker.heading,\n    },\n    device: {},\n  };\n}\n\nexport async function fetchLocationHistory(\n  userId: string\n): Promise<Location[]> {\n  const markers = await prisma.locationMarker.findMany({\n    where: {\n      Session: {\n        userId,\n      },\n    },\n    orderBy: {\n      createdAt: \"desc\",\n    },\n  });\n\n  return markers.map((marker) => ({\n    uid: userId,\n    ts: marker.createdAt,\n    coords: {\n      lat: marker.lat,\n      lng: marker.long,\n      accuracy: marker.accuracy,\n      speed: marker.speed,\n      heading: marker.heading,\n    },\n    device: {},\n  }));\n}\n\nexport async function fetchAllUsersLatestLocations(): Promise<\n  Array<{\n    userId: string;\n    location: Location;\n    userName?: string;\n  }>\n> {\n  try {\n    // Get all unique users who have location markers\n    const sessions = await prisma.session.findMany({\n      distinct: [\"userId\"],\n      orderBy: {\n        startTime: \"desc\",\n      },\n      include: {\n        User: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n          },\n        },\n        locationMarkers: {\n          orderBy: {\n            createdAt: \"desc\",\n          },\n          take: 1,\n        },\n      },\n    });\n\n    const allLocations: Array<{\n      userId: string;\n      location: Location;\n      userName?: string;\n    }> = [];\n\n    for (const session of sessions) {\n      if (session.locationMarkers.length > 0) {\n        const marker = session.locationMarkers[0]!;\n        const userName = session.User\n          ? `${session.User.firstName} ${session.User.lastName || \"\"}`.trim()\n          : session.userId;\n\n        allLocations.push({\n          userId: session.userId,\n          location: {\n            uid: session.userId,\n            ts: marker.createdAt,\n            coords: {\n              lat: marker.lat,\n              lng: marker.long,\n              accuracy: marker.accuracy,\n              speed: marker.speed,\n              heading: marker.heading,\n            },\n            device: {},\n          },\n          userName,\n        });\n      }\n    }\n\n    return allLocations;\n  } catch (err) {\n    console.error(\"Error fetching all users locations:\", err);\n    return [];\n  }\n}\n\nexport function validateLocationPayload(\n  payload: Partial<Location>\n): string | null {\n  if (\n    !payload.coords ||\n    typeof payload.coords.lat !== \"number\" ||\n    typeof payload.coords.lng !== \"number\"\n  ) {\n    return \"Missing or invalid coordinates\";\n  }\n  return null;\n}\n\nexport async function saveUserLocation(\n  userId: string,\n  sessionId: number,\n  coords: Location[\"coords\"],\n  device?: Location[\"device\"]\n): Promise<boolean> {\n  try {\n    await prisma.locationMarker.create({\n      data: {\n        sessionId,\n        lat: coords.lat,\n        long: coords.lng,\n        accuracy: coords.accuracy ?? null,\n        speed: coords.speed ?? null,\n        heading: coords.heading ?? null,\n      },\n    });\n    return true;\n  } catch (err) {\n    console.error(\"Error saving location marker:\", err);\n    throw err;\n  }\n}\n"],"names":[],"mappings":";;AAAA,OAAO,MAAM,MAAM,kBAAkB,CAAC;AAGtC,MAAM,CAAC,KAAK,UAAU,mBAAmB,CACvC,MAAc;IAEd,MAAM,MAAM,GAAG,MAAM,MAAM,CAAC,cAAc,CAAC,SAAS,CAAC;QACnD,KAAK,EAAE;YACL,OAAO,EAAE;gBACP,MAAM;aACP;SACF;QACD,OAAO,EAAE;YACP,SAAS,EAAE,MAAM;SAClB;KACF,CAAC,CAAC;IAEH,IAAI,CAAC,MAAM,EAAE,CAAC;QACZ,OAAO,CAAC,IAAI,CAAC,yCAAyC,MAAM,EAAE,CAAC,CAAC;QAChE,OAAO,IAAI,CAAC;IACd,CAAC;IAED,OAAO,CAAC,GAAG,CAAC,uCAAuC,MAAM,kBAAkB,CAAC,CAAC;IAE7E,OAAO;QACL,GAAG,EAAE,MAAM;QACX,EAAE,EAAE,MAAM,CAAC,SAAS;QACpB,MAAM,EAAE;YACN,GAAG,EAAE,MAAM,CAAC,GAAG;YACf,GAAG,EAAE,MAAM,CAAC,IAAI;YAChB,QAAQ,EAAE,MAAM,CAAC,QAAQ;YACzB,KAAK,EAAE,MAAM,CAAC,KAAK;YACnB,OAAO,EAAE,MAAM,CAAC,OAAO;SACxB;QACD,MAAM,EAAE,EAAE;KACX,CAAC;AACJ,CAAC;AAED,MAAM,CAAC,KAAK,UAAU,oBAAoB,CACxC,MAAc;IAEd,MAAM,OAAO,GAAG,MAAM,MAAM,CAAC,cAAc,CAAC,QAAQ,CAAC;QACnD,KAAK,EAAE;YACL,OAAO,EAAE;gBACP,MAAM;aACP;SACF;QACD,OAAO,EAAE;YACP,SAAS,EAAE,MAAM;SAClB;KACF,CAAC,CAAC;IAEH,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,CAAC;QAC9B,GAAG,EAAE,MAAM;QACX,EAAE,EAAE,MAAM,CAAC,SAAS;QACpB,MAAM,EAAE;YACN,GAAG,EAAE,MAAM,CAAC,GAAG;YACf,GAAG,EAAE,MAAM,CAAC,IAAI;YAChB,QAAQ,EAAE,MAAM,CAAC,QAAQ;YACzB,KAAK,EAAE,MAAM,CAAC,KAAK;YACnB,OAAO,EAAE,MAAM,CAAC,OAAO;SACxB;QACD,MAAM,EAAE,EAAE;KACX,CAAC,CAAC,CAAC;AACN,CAAC;AAED,MAAM,CAAC,KAAK,UAAU,4BAA4B;IAOhD,IAAI,CAAC;QACH,iDAAiD;QACjD,MAAM,QAAQ,GAAG,MAAM,MAAM,CAAC,OAAO,CAAC,QAAQ,CAAC;YAC7C,QAAQ,EAAE,CAAC,QAAQ,CAAC;YACpB,OAAO,EAAE;gBACP,SAAS,EAAE,MAAM;aAClB;YACD,OAAO,EAAE;gBACP,IAAI,EAAE;oBACJ,MAAM,EAAE;wBACN,EAAE,EAAE,IAAI;wBACR,SAAS,EAAE,IAAI;wBACf,QAAQ,EAAE,IAAI;qBACf;iBACF;gBACD,eAAe,EAAE;oBACf,OAAO,EAAE;wBACP,SAAS,EAAE,MAAM;qBAClB;oBACD,IAAI,EAAE,CAAC;iBACR;aACF;SACF,CAAC,CAAC;QAEH,MAAM,YAAY,GAIb,EAAE,CAAC;QAER,KAAK,MAAM,OAAO,IAAI,QAAQ,EAAE,CAAC;YAC/B,IAAI,OAAO,CAAC,eAAe,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBACvC,MAAM,MAAM,GAAG,OAAO,CAAC,eAAe,CAAC,CAAC,CAAE,CAAC;gBAC3C,MAAM,QAAQ,GAAG,OAAO,CAAC,IAAI;oBAC3B,CAAC,CAAC,GAAG,OAAO,CAAC,IAAI,CAAC,SAAS,IAAI,OAAO,CAAC,IAAI,CAAC,QAAQ,IAAI,EAAE,EAAE,CAAC,IAAI,EAAE;oBACnE,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC;gBAEnB,YAAY,CAAC,IAAI,CAAC;oBAChB,MAAM,EAAE,OAAO,CAAC,MAAM;oBACtB,QAAQ,EAAE;wBACR,GAAG,EAAE,OAAO,CAAC,MAAM;wBACnB,EAAE,EAAE,MAAM,CAAC,SAAS;wBACpB,MAAM,EAAE;4BACN,GAAG,EAAE,MAAM,CAAC,GAAG;4BACf,GAAG,EAAE,MAAM,CAAC,IAAI;4BAChB,QAAQ,EAAE,MAAM,CAAC,QAAQ;4BACzB,KAAK,EAAE,MAAM,CAAC,KAAK;4BACnB,OAAO,EAAE,MAAM,CAAC,OAAO;yBACxB;wBACD,MAAM,EAAE,EAAE;qBACX;oBACD,QAAQ;iBACT,CAAC,CAAC;YACL,CAAC;QACH,CAAC;QAED,OAAO,YAAY,CAAC;IACtB,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,OAAO,CAAC,KAAK,CAAC,qCAAqC,EAAE,GAAG,CAAC,CAAC;QAC1D,OAAO,EAAE,CAAC;IACZ,CAAC;AACH,CAAC;AAED,MAAM,UAAU,uBAAuB,CACrC,OAA0B;IAE1B,IACE,CAAC,OAAO,CAAC,MAAM;QACf,OAAO,OAAO,CAAC,MAAM,CAAC,GAAG,KAAK,QAAQ;QACtC,OAAO,OAAO,CAAC,MAAM,CAAC,GAAG,KAAK,QAAQ,EACtC,CAAC;QACD,OAAO,gCAAgC,CAAC;IAC1C,CAAC;IACD,OAAO,IAAI,CAAC;AACd,CAAC;AAED,MAAM,CAAC,KAAK,UAAU,gBAAgB,CACpC,MAAc,EACd,SAAiB,EACjB,MAA0B,EAC1B,MAA2B;IAE3B,IAAI,CAAC;QACH,MAAM,MAAM,CAAC,cAAc,CAAC,MAAM,CAAC;YACjC,IAAI,EAAE;gBACJ,SAAS;gBACT,GAAG,EAAE,MAAM,CAAC,GAAG;gBACf,IAAI,EAAE,MAAM,CAAC,GAAG;gBAChB,QAAQ,EAAE,MAAM,CAAC,QAAQ,IAAI,IAAI;gBACjC,KAAK,EAAE,MAAM,CAAC,KAAK,IAAI,IAAI;gBAC3B,OAAO,EAAE,MAAM,CAAC,OAAO,IAAI,IAAI;aAChC;SACF,CAAC,CAAC;QACH,OAAO,IAAI,CAAC;IACd,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,OAAO,CAAC,KAAK,CAAC,+BAA+B,EAAE,GAAG,CAAC,CAAC;QACpD,MAAM,GAAG,CAAC;IACZ,CAAC;AACH,CAAC","debug_id":"17734c60-656f-5b2d-a1f7-0e4978af6e6c"}