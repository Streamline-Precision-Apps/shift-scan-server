{"version":3,"file":"adminBaseService.js","sources":["src/services/adminBaseService.ts"],"sourceRoot":"/","sourcesContent":["import prisma from \"../lib/prisma.js\";\n\nexport async function fetchNotificationServiceByUserId(\n  userId: string,\n  resolvedSince?: string\n) {\n  // fetch subscribed notifications\n  const subscribedNotifications = await prisma.topicSubscription.findMany({\n    where: {\n      userId: userId,\n    },\n  });\n\n  const subscribedTopics = subscribedNotifications.map(\n    (subscription) => subscription.topic\n  );\n\n  // Handle case where user has no subscriptions\n  if (subscribedTopics.length === 0) {\n    return {\n      notifications: [],\n      count: 0,\n      resolved: [],\n      unreadCount: 0,\n    };\n  }\n\n  // Unresolved notifications with full data\n  const notifications = await prisma.notification.findMany({\n    where: {\n      Response: {\n        is: null,\n      },\n      topic: {\n        in: subscribedTopics,\n      },\n    },\n    include: {\n      Response: {\n        include: {\n          user: {\n            select: {\n              firstName: true,\n              lastName: true,\n            },\n          },\n        },\n      },\n      Reads: {\n        select: { userId: true },\n      },\n    },\n    orderBy: {\n      createdAt: \"desc\",\n    },\n  });\n\n  // Build where clause for resolved notifications\n  const resolvedWhereClause: any = {\n    Response: {\n      isNot: null,\n    },\n    topic: {\n      in: subscribedTopics,\n    },\n  };\n\n  // Add date filter if resolvedSince is provided\n  if (resolvedSince) {\n    resolvedWhereClause.createdAt = {\n      gte: new Date(resolvedSince),\n    };\n  }\n\n  const count = await prisma.notification.count({\n    where: resolvedWhereClause,\n  });\n\n  // Resolved notifications with full data\n  const resolved = await prisma.notification.findMany({\n    where: resolvedWhereClause,\n    include: {\n      Response: {\n        include: {\n          user: {\n            select: {\n              firstName: true,\n              lastName: true,\n            },\n          },\n        },\n      },\n      Reads: {\n        select: { userId: true },\n      },\n    },\n    orderBy: {\n      createdAt: \"desc\",\n    },\n  });\n\n  // Unread count filtered by subscribed topics\n  const unreadCount = await prisma.notification.count({\n    where: {\n      topic: {\n        in: subscribedTopics,\n      },\n      Reads: {\n        none: {\n          userId: userId,\n        },\n      },\n    },\n  });\n\n  return {\n    notifications,\n    count,\n    resolved,\n    unreadCount,\n  };\n}\n\nexport async function getDashboardData(userId: string) {\n  const clockedInUsers = await prisma.user.count({\n    where: {\n      clockedIn: true,\n    },\n  });\n\n  const totalPendingTimesheets = await prisma.timeSheet.count({\n    where: {\n      status: \"PENDING\",\n    },\n  });\n\n  const pendingForms = await prisma.formSubmission.count({\n    where: {\n      status: \"PENDING\",\n    },\n  });\n\n  const equipmentAwaitingApproval = await prisma.equipment.count({\n    where: {\n      approvalStatus: \"PENDING\",\n    },\n  });\n\n  const jobsitesAwaitingApproval = await prisma.jobsite.count({\n    where: {\n      approvalStatus: \"PENDING\",\n    },\n  });\n  return {\n    clockedInUsers,\n    totalPendingTimesheets,\n    pendingForms,\n    equipmentAwaitingApproval,\n    jobsitesAwaitingApproval,\n  };\n}\n\nexport async function getUserTopicPreferences(userId: string) {\n  const preferences = await prisma.topicSubscription.findMany({\n    where: { userId: userId },\n    select: {\n      topic: true,\n    },\n  });\n  return preferences;\n}\n"],"names":[],"mappings":"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","debug_id":"67a8cdc8-f9ed-562c-beab-e25e4f34c7e8"}