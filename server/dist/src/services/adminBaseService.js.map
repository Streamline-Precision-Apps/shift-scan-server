{"version":3,"file":"adminBaseService.js","sources":["src/services/adminBaseService.ts"],"sourceRoot":"/","sourcesContent":["import prisma from \"../lib/prisma.js\";\r\n\r\nexport async function fetchNotificationServiceByUserId(userId: string) {\r\n  // fetch subscribed notifications\r\n  const subscribedNotifications = await prisma.topicSubscription.findMany({\r\n    where: {\r\n      userId: userId,\r\n    },\r\n  });\r\n\r\n  const subscribedTopics = subscribedNotifications.map(\r\n    (subscription) => subscription.topic\r\n  );\r\n\r\n  // Handle case where user has no subscriptions\r\n  if (subscribedTopics.length === 0) {\r\n    return {\r\n      notifications: [],\r\n      count: 0,\r\n      resolved: [],\r\n      unreadCount: 0,\r\n    };\r\n  }\r\n\r\n  // Unresolved notifications with full data\r\n  const notifications = await prisma.notification.findMany({\r\n    where: {\r\n      Response: {\r\n        is: null,\r\n      },\r\n      topic: {\r\n        in: subscribedTopics,\r\n      },\r\n    },\r\n    include: {\r\n      Response: {\r\n        include: {\r\n          user: {\r\n            select: {\r\n              firstName: true,\r\n              lastName: true,\r\n            },\r\n          },\r\n        },\r\n      },\r\n      Reads: {\r\n        select: { userId: true },\r\n      },\r\n    },\r\n    orderBy: {\r\n      createdAt: \"desc\",\r\n    },\r\n  });\r\n\r\n  const count = await prisma.notification.count({\r\n    where: {\r\n      Response: {\r\n        isNot: null,\r\n      },\r\n      topic: {\r\n        in: subscribedTopics,\r\n      },\r\n    },\r\n  });\r\n\r\n  // Resolved notifications with full data\r\n  const resolved = await prisma.notification.findMany({\r\n    where: {\r\n      Response: {\r\n        isNot: null,\r\n      },\r\n      topic: {\r\n        in: subscribedTopics,\r\n      },\r\n    },\r\n    include: {\r\n      Response: {\r\n        include: {\r\n          user: {\r\n            select: {\r\n              firstName: true,\r\n              lastName: true,\r\n            },\r\n          },\r\n        },\r\n      },\r\n      Reads: {\r\n        select: { userId: true },\r\n      },\r\n    },\r\n    orderBy: {\r\n      createdAt: \"desc\",\r\n    },\r\n  });\r\n\r\n  // Unread count filtered by subscribed topics\r\n  const unreadCount = await prisma.notification.count({\r\n    where: {\r\n      topic: {\r\n        in: subscribedTopics,\r\n      },\r\n      Reads: {\r\n        none: {\r\n          userId: userId,\r\n        },\r\n      },\r\n    },\r\n  });\r\n\r\n  return {\r\n    notifications,\r\n    count,\r\n    resolved,\r\n    unreadCount,\r\n  };\r\n}\r\n\r\nexport async function getDashboardData(userId: string) {\r\n  const clockedInUsers = await prisma.user.count({\r\n    where: {\r\n      clockedIn: true,\r\n    },\r\n  });\r\n\r\n  const totalPendingTimesheets = await prisma.timeSheet.count({\r\n    where: {\r\n      status: \"PENDING\",\r\n    },\r\n  });\r\n\r\n  const pendingForms = await prisma.formSubmission.count({\r\n    where: {\r\n      status: \"PENDING\",\r\n    },\r\n  });\r\n\r\n  const equipmentAwaitingApproval = await prisma.equipment.count({\r\n    where: {\r\n      approvalStatus: \"PENDING\",\r\n    },\r\n  });\r\n\r\n  const jobsitesAwaitingApproval = await prisma.jobsite.count({\r\n    where: {\r\n      approvalStatus: \"PENDING\",\r\n    },\r\n  });\r\n  return {\r\n    clockedInUsers,\r\n    totalPendingTimesheets,\r\n    pendingForms,\r\n    equipmentAwaitingApproval,\r\n    jobsitesAwaitingApproval,\r\n  };\r\n}\r\n\r\nexport async function getUserTopicPreferences(userId: string) {\r\n  const preferences = await prisma.topicSubscription.findMany({\r\n    where: { userId: userId },\r\n    select: {\r\n      topic: true,\r\n    },\r\n  });\r\n  return preferences;\r\n}\r\n"],"names":[],"mappings":"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","debug_id":"4d462603-7354-5f14-99ca-4a2acc158104"}