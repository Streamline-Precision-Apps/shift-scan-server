{"version":3,"file":"pushNotificationServices.js","sources":["src/services/pushNotificationServices.ts"],"sourceRoot":"/","sourcesContent":["import prisma from \"../lib/prisma.js\";\n\n/**\n * Mark a single notification as read for the user in the request.\n */\nexport async function updateNotificationReadStatusService(\n  notificationId: number,\n  userId: string\n) {\n  if (!userId) throw new Error(\"Unauthorized\");\n  if (!notificationId) throw new Error(\"Missing notificationId\");\n\n  // Check if the read record already exists\n  const existingRead = await prisma.notificationRead.findFirst({\n    where: { notificationId, userId },\n  });\n  if (!existingRead) {\n    await prisma.notificationRead.create({\n      data: { notificationId, userId },\n    });\n  } else {\n    await prisma.notificationRead.update({\n      where: { id: existingRead.id },\n      data: { readAt: new Date() },\n    });\n  }\n  return { notificationId };\n}\n\n/**\n * Mark all notifications as read for the user in the request.\n */\nexport async function markAllNotificationsAsReadService(userId: string) {\n  if (!userId) throw new Error(\"Unauthorized\");\n  // Fetch all unread notifications for the user\n  const unreadNotifications = await prisma.notification.findMany({\n    where: { Reads: { none: { userId } } },\n    select: { id: true },\n  });\n  const readRecords = unreadNotifications.map((n: any) => ({\n    notificationId: n.id,\n    userId,\n    readAt: new Date(),\n  }));\n  if (readRecords.length > 0) {\n    await prisma.notificationRead.createMany({\n      data: readRecords,\n      skipDuplicates: true,\n    });\n  }\n  return { markedCount: readRecords.length };\n}\n\n/**\n * Mark broken equipment notification as read and create response if needed.\n */\nexport async function markBrokenEquipmentNotificationsAsReadService(\n  notificationId: number,\n  userId: string\n) {\n  if (!userId) throw new Error(\"Unauthorized\");\n  if (!notificationId) throw new Error(\"Missing notificationId\");\n\n  const notification = await prisma.notification.findFirst({\n    where: {\n      id: notificationId,\n      topic: \"equipment-break\",\n      Response: { is: null },\n    },\n  });\n  if (notification) {\n    return { success: false, message: \"Notification action done\" };\n  }\n  if (!notification) {\n    await prisma.$transaction(async (tx: any) => {\n      await tx.notificationResponse.create({\n        data: {\n          notificationId,\n          userId,\n          response: \"Repaired\",\n          respondedAt: new Date(),\n        },\n      });\n      await tx.notificationRead.create({\n        data: {\n          notificationId,\n          userId,\n          readAt: new Date(),\n        },\n      });\n    });\n  }\n  return { notificationId };\n}\n"],"names":[],"mappings":"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","debug_id":"3cde41b1-3d0b-5939-88a8-918992eef769"}