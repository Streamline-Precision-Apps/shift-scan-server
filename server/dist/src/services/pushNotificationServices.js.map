{"version":3,"file":"pushNotificationServices.js","sources":["src/services/pushNotificationServices.ts"],"sourceRoot":"/","sourcesContent":["import prisma from \"../lib/prisma.js\";\r\n\r\n/**\r\n * Mark a single notification as read for the user in the request.\r\n */\r\nexport async function updateNotificationReadStatusService(\r\n  notificationId: number,\r\n  userId: string\r\n) {\r\n  if (!userId) throw new Error(\"Unauthorized\");\r\n  if (!notificationId) throw new Error(\"Missing notificationId\");\r\n\r\n  // Check if the read record already exists\r\n  const existingRead = await prisma.notificationRead.findFirst({\r\n    where: { notificationId, userId },\r\n  });\r\n  if (!existingRead) {\r\n    await prisma.notificationRead.create({\r\n      data: { notificationId, userId },\r\n    });\r\n  } else {\r\n    await prisma.notificationRead.update({\r\n      where: { id: existingRead.id },\r\n      data: { readAt: new Date() },\r\n    });\r\n  }\r\n  return { notificationId };\r\n}\r\n\r\n/**\r\n * Mark all notifications as read for the user in the request.\r\n */\r\nexport async function markAllNotificationsAsReadService(userId: string) {\r\n  if (!userId) throw new Error(\"Unauthorized\");\r\n  // Fetch all unread notifications for the user\r\n  const unreadNotifications = await prisma.notification.findMany({\r\n    where: { Reads: { none: { userId } } },\r\n    select: { id: true },\r\n  });\r\n  const readRecords = unreadNotifications.map((n: any) => ({\r\n    notificationId: n.id,\r\n    userId,\r\n    readAt: new Date(),\r\n  }));\r\n  if (readRecords.length > 0) {\r\n    await prisma.notificationRead.createMany({\r\n      data: readRecords,\r\n      skipDuplicates: true,\r\n    });\r\n  }\r\n  return { markedCount: readRecords.length };\r\n}\r\n\r\n/**\r\n * Mark broken equipment notification as read and create response if needed.\r\n */\r\nexport async function markBrokenEquipmentNotificationsAsReadService(\r\n  notificationId: number,\r\n  userId: string\r\n) {\r\n  if (!userId) throw new Error(\"Unauthorized\");\r\n  if (!notificationId) throw new Error(\"Missing notificationId\");\r\n\r\n  const notification = await prisma.notification.findFirst({\r\n    where: {\r\n      id: notificationId,\r\n      topic: \"equipment-break\",\r\n      Response: { is: null },\r\n    },\r\n  });\r\n  if (notification) {\r\n    return { success: false, message: \"Notification action done\" };\r\n  }\r\n  if (!notification) {\r\n    await prisma.$transaction(async (tx: any) => {\r\n      await tx.notificationResponse.create({\r\n        data: {\r\n          notificationId,\r\n          userId,\r\n          response: \"Repaired\",\r\n          respondedAt: new Date(),\r\n        },\r\n      });\r\n      await tx.notificationRead.create({\r\n        data: {\r\n          notificationId,\r\n          userId,\r\n          readAt: new Date(),\r\n        },\r\n      });\r\n    });\r\n  }\r\n  return { notificationId };\r\n}\r\n"],"names":[],"mappings":"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","debug_id":"f31b69d4-97e4-56d6-842f-1614782bf172"}