{"version":3,"file":"adminTagService.js","sources":["src/services/adminTagService.ts"],"sourceRoot":"/","sourcesContent":["import type { Prisma } from \"../../generated/prisma/index.js\";\nimport prisma from \"../lib/prisma.js\";\n\nexport async function getAllTags(\n  search: string,\n  page: number | undefined,\n  pageSize: number | undefined,\n  skip: number | undefined\n) {\n  try {\n    if (search !== \"\") {\n      page = 1;\n      pageSize = undefined;\n      skip = undefined;\n      const totalPages = 1;\n      const tagSummary = await prisma.cCTag.findMany({\n        include: {\n          CostCodes: {\n            select: {\n              id: true,\n              name: true,\n              isActive: true,\n            },\n          },\n          Jobsites: {\n            select: {\n              id: true,\n              name: true,\n            },\n          },\n        },\n        orderBy: {\n          name: \"asc\",\n        },\n      });\n      const total = tagSummary.length;\n      return {\n        tagSummary,\n        total,\n        page,\n        pageSize,\n        totalPages,\n      };\n    } else {\n      // Use the provided page and pageSize directly\n      page = page || 1;\n      pageSize = pageSize || 10;\n      skip = (page - 1) * pageSize;\n      const take = pageSize;\n      // Fetch total count for pagination\n      const total = await prisma.cCTag.count();\n      const totalPages = Math.ceil(total / pageSize);\n      // Fetch only essential fields from tags\n      const tagSummary = await prisma.cCTag.findMany({\n        skip,\n        take,\n        include: {\n          CostCodes: {\n            select: {\n              id: true,\n              name: true,\n              isActive: true,\n            },\n          },\n          Jobsites: {\n            select: {\n              id: true,\n              name: true,\n            },\n          },\n        },\n        orderBy: {\n          name: \"asc\",\n        },\n      });\n      return {\n        tagSummary,\n        total,\n        page,\n        pageSize,\n        totalPages,\n      };\n    }\n  } catch (error) {\n    console.error(\"Error in getAllTags service:\", error);\n    throw error;\n  }\n}\n\nexport async function getTagById(id: string) {\n  return await prisma.cCTag.findUnique({\n    where: {\n      id,\n    },\n    include: {\n      Jobsites: {\n        select: {\n          id: true,\n          name: true,\n        },\n      },\n      CostCodes: {\n        select: {\n          id: true,\n          name: true,\n        },\n      },\n    },\n  });\n}\n\nexport async function createTag(payload: {\n  name: string;\n  description: string;\n  CostCodes: {\n    id: string;\n    name: string;\n  }[];\n  Jobsites: {\n    id: string;\n    name: string;\n  }[];\n}) {\n  const existingTag = await prisma.cCTag.findUnique({\n    where: {\n      name: payload.name.trim(),\n    },\n  });\n  if (existingTag) {\n    throw new Error(\"Tag with this name already exists\");\n  }\n\n  const data: any = {\n    name: payload.name.trim(),\n    description: payload.description.trim(),\n  };\n  if (payload.CostCodes && payload.CostCodes.length > 0) {\n    data.CostCodes = {\n      connect: payload.CostCodes.map((cc) => ({ id: cc.id })),\n    };\n  }\n  if (payload.Jobsites && payload.Jobsites.length > 0) {\n    data.Jobsites = { connect: payload.Jobsites.map((js) => ({ id: js.id })) };\n  }\n  return await prisma.cCTag.create({\n    data,\n    include: {\n      CostCodes: {\n        select: {\n          id: true,\n          name: true,\n        },\n      },\n      Jobsites: {\n        select: {\n          id: true,\n          name: true,\n        },\n      },\n    },\n  });\n}\n\nexport type UpdateTagPayload = {\n  name?: string;\n  description?: string;\n  Jobsites?: { id: string; name?: string }[];\n  CostCodes?: { id: string; name?: string }[];\n};\n\nexport async function updateTag(id: string, payload: UpdateTagPayload) {\n  const existingTag = await prisma.cCTag.findUnique({\n    where: { id },\n    include: {\n      Jobsites: { select: { id: true, name: true } },\n      CostCodes: { select: { id: true, name: true } },\n    },\n  });\n  if (!existingTag) {\n    throw new Error(\"Tag not found\");\n  }\n\n  const updateData: Prisma.CCTagUpdateInput = {};\n  if (payload.name !== undefined) {\n    updateData.name = payload.name.trim();\n  }\n  if (payload.description !== undefined) {\n    updateData.description = payload.description.trim();\n  }\n  if (payload.Jobsites) {\n    // Normalize: convert string[] to {id: string}[] if needed\n    const jobsitesArray = payload.Jobsites.map((js) =>\n      typeof js === \"string\" ? { id: js } : js\n    );\n    const filteredJobsites = jobsitesArray.filter((js) => js && js.id);\n    if (filteredJobsites.length > 0) {\n      updateData.Jobsites = {\n        set: filteredJobsites.map((js) => ({ id: js.id })),\n      };\n    }\n  }\n  if (payload.CostCodes) {\n    const filteredCostCodes = payload.CostCodes.filter((cc) => cc && cc.id);\n    if (filteredCostCodes.length > 0) {\n      updateData.CostCodes = {\n        set: filteredCostCodes.map((cc) => ({ id: cc.id })),\n      };\n    }\n  }\n\n  return await prisma.cCTag.update({\n    where: { id },\n    data: updateData,\n    include: {\n      Jobsites: { select: { id: true, name: true } },\n      CostCodes: { select: { id: true, name: true } },\n    },\n  });\n}\n\nexport async function deleteTag(id: string) {\n  return await prisma.cCTag.delete({\n    where: { id },\n  });\n}\n"],"names":[],"mappings":"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","debug_id":"ad0ae31c-6019-521a-a206-b97d1ca91e5d"}