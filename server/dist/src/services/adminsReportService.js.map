{"version":3,"file":"adminsReportService.js","sources":["src/services/adminsReportService.ts"],"sourceRoot":"/","sourcesContent":["import prisma from \"../lib/prisma.js\";\r\n\r\nexport async function getTruckingReport() {\r\n  const overWeightReport = await prisma.truckingLog.findMany({\r\n    where: {\r\n      endingMileage: { not: null },\r\n    },\r\n    select: {\r\n      id: true,\r\n      startingMileage: true,\r\n      endingMileage: true,\r\n      Truck: {\r\n        select: {\r\n          id: true,\r\n          name: true,\r\n        },\r\n      },\r\n      Trailer: {\r\n        select: {\r\n          id: true,\r\n          name: true,\r\n        },\r\n      },\r\n      TimeSheet: {\r\n        select: {\r\n          User: {\r\n            select: {\r\n              firstName: true,\r\n              lastName: true,\r\n            },\r\n          },\r\n          date: true,\r\n          comment: true,\r\n          Jobsite: {\r\n            select: { name: true },\r\n          },\r\n        },\r\n      },\r\n      EquipmentHauled: {\r\n        select: {\r\n          truckingLogId: true,\r\n          Equipment: { select: { name: true, id: true } },\r\n          source: true,\r\n          destination: true,\r\n          startMileage: true,\r\n          endMileage: true,\r\n        },\r\n      },\r\n      Materials: {\r\n        select: {\r\n          truckingLogId: true,\r\n          name: true,\r\n          LocationOfMaterial: true,\r\n          quantity: true,\r\n          unit: true,\r\n        },\r\n      },\r\n      RefuelLogs: {\r\n        select: {\r\n          truckingLogId: true,\r\n          milesAtFueling: true,\r\n          gallonsRefueled: true,\r\n        },\r\n      },\r\n      StateMileages: {\r\n        select: {\r\n          truckingLogId: true,\r\n          state: true,\r\n          stateLineMileage: true,\r\n        },\r\n      },\r\n    },\r\n  });\r\n\r\n  const formattedReport = overWeightReport.map((log) => ({\r\n    id: log.id,\r\n    driver: `${log.TimeSheet?.User?.firstName} ${log.TimeSheet?.User?.lastName}`,\r\n    truckId: log.Truck?.id ?? null,\r\n    truckName: log.Truck?.name ?? null,\r\n    trailerId: log.Trailer?.id ?? null,\r\n    trailerName: log.Trailer?.name ?? null,\r\n    date: log.TimeSheet?.date ?? null,\r\n    jobId: log.TimeSheet?.Jobsite?.name ?? null,\r\n    Equipment: log.EquipmentHauled.map((equipment) => ({\r\n      name: equipment.Equipment?.name || \"\",\r\n      id: equipment.Equipment?.id || null,\r\n      source: equipment.source,\r\n      destination: equipment.destination,\r\n      startMileage: equipment.startMileage,\r\n      endMileage: equipment.endMileage,\r\n    })),\r\n    Materials: log.Materials.map((material) => ({\r\n      id: material.truckingLogId,\r\n      name: material.name,\r\n      location: material.LocationOfMaterial,\r\n      quantity: material.quantity,\r\n      unit: material.unit,\r\n    })),\r\n    StartingMileage: log.startingMileage,\r\n    Fuel: log.RefuelLogs.map((fuel) => ({\r\n      id: fuel.truckingLogId,\r\n      milesAtFueling: fuel.milesAtFueling,\r\n      gallonsRefueled: fuel.gallonsRefueled,\r\n    })),\r\n    StateMileages: log.StateMileages.map((state) => ({\r\n      id: state.truckingLogId,\r\n      state: state.state,\r\n      stateLineMileage: state.stateLineMileage,\r\n    })),\r\n    EndingMileage: log.endingMileage,\r\n    notes: log.TimeSheet?.comment ?? null,\r\n  }));\r\n\r\n  return formattedReport;\r\n}\r\n// Define a type for the Tasco report row\r\ntype TascoReportRow = {\r\n  id: string;\r\n  shiftType: string;\r\n  submittedDate: Date;\r\n  employee: string;\r\n  dateWorked: Date;\r\n  laborType: string | null;\r\n  equipment: string;\r\n  loadsABCDE: number | null;\r\n  loadsF: number | null;\r\n  materials: string;\r\n  startTime: Date;\r\n  endTime: Date | null;\r\n  LoadType: \"SCREENED\" | \"UNSCREENED\";\r\n};\r\n\r\nexport async function getTascoReport(): Promise<TascoReportRow[]> {\r\n  const report = await prisma.timeSheet.findMany({\r\n    select: {\r\n      date: true,\r\n      startTime: true,\r\n      endTime: true,\r\n      User: {\r\n        select: {\r\n          firstName: true,\r\n          lastName: true,\r\n        },\r\n      },\r\n      TascoLogs: {\r\n        select: {\r\n          id: true,\r\n          shiftType: true,\r\n          laborType: true,\r\n          Equipment: {\r\n            select: {\r\n              name: true,\r\n            },\r\n          },\r\n          screenType: true,\r\n          LoadQuantity: true,\r\n          materialType: true,\r\n        },\r\n      },\r\n    },\r\n  });\r\n\r\n  // Filter out timesheets with empty TascoLogs arrays\r\n  const filteredReport = report.filter(\r\n    (item) => Array.isArray(item.TascoLogs) && item.TascoLogs.length > 0\r\n  );\r\n\r\n  const tascoReport: TascoReportRow[] = filteredReport\r\n    .filter((log) => Array.isArray(log.TascoLogs) && log.TascoLogs.length > 0)\r\n    .map((log) => {\r\n      const firstLog = log.TascoLogs[0];\r\n      if (!firstLog) {\r\n        // Should not happen due to filter, but for type safety\r\n        throw new Error(\"TascoLog entry missing for timesheet\");\r\n      }\r\n      const shiftType = firstLog.shiftType;\r\n      const laborType = firstLog.laborType ?? null;\r\n      const loadQuantity = firstLog.LoadQuantity ?? 0;\r\n      const loadsABCDE =\r\n        shiftType === \"ABCD Shift\" || shiftType === \"E Shift\"\r\n          ? loadQuantity\r\n          : null;\r\n      const loadsF = shiftType === \"F Shift\" ? loadQuantity : null;\r\n      let loadType: \"SCREENED\" | \"UNSCREENED\" = \"UNSCREENED\";\r\n      if (firstLog.screenType === \"SCREENED\") loadType = \"SCREENED\";\r\n\r\n      return {\r\n        id: firstLog.id,\r\n        shiftType: shiftType,\r\n        submittedDate: log.date,\r\n        employee: `${log.User.firstName} ${log.User.lastName}`,\r\n        dateWorked: log.date,\r\n        laborType: laborType,\r\n        equipment: firstLog.Equipment?.name ?? \"\",\r\n        loadsABCDE: loadsABCDE,\r\n        loadsF: loadsF,\r\n        materials: firstLog.materialType ?? \"\",\r\n        startTime: log.startTime,\r\n        endTime: log.endTime ?? null,\r\n        LoadType: loadType,\r\n      };\r\n    });\r\n\r\n  return tascoReport;\r\n}\r\n\r\nexport async function getMechanicReport() {\r\n  const report = await prisma.timeSheet.findMany({\r\n    select: {\r\n      date: true,\r\n      User: {\r\n        select: {\r\n          firstName: true,\r\n          lastName: true,\r\n        },\r\n      },\r\n      Maintenance: {\r\n        select: {\r\n          id: true,\r\n          hours: true,\r\n          description: true,\r\n          Equipment: {\r\n            select: {\r\n              name: true,\r\n            },\r\n          },\r\n        },\r\n      },\r\n    },\r\n  });\r\n\r\n  // Filter out timesheets with empty Maintenance arrays\r\n  const filteredReport = report.filter(\r\n    (item) => Array.isArray(item.Maintenance) && item.Maintenance.length > 0\r\n  );\r\n\r\n  // Flatten the data to have one row per mechanic project\r\n  const mechanicReport = filteredReport.flatMap((timesheet) =>\r\n    timesheet.Maintenance.map((project) => ({\r\n      id: project.id,\r\n      employeeName: `${timesheet.User.firstName} ${timesheet.User.lastName}`,\r\n      equipmentWorkedOn: project.Equipment?.name ?? \"Unknown Equipment\",\r\n      hours: project.hours ?? 0,\r\n      comments: project.description ?? \"\",\r\n      dateWorked: timesheet.date,\r\n    }))\r\n  );\r\n\r\n  return mechanicReport;\r\n}\r\n"],"names":[],"mappings":"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","debug_id":"b99d9c85-b046-5d34-8cde-c87dfd0034d3"}