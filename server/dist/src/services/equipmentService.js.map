{"version":3,"file":"equipmentService.js","sources":["src/services/equipmentService.ts"],"sourceRoot":"/","sourcesContent":["// server/src/services/equipmentService.ts\r\nimport prisma from \"../lib/prisma.js\";\r\nimport { EquipmentTags, OwnershipType } from \"../../generated/prisma/index.js\";\r\n\r\nexport async function getEquipment(query: { qrg?: boolean; clock?: boolean }) {\r\n  if (query.qrg) {\r\n    return prisma.equipment.findMany({\r\n      select: {\r\n        id: true,\r\n        qrId: true,\r\n        name: true,\r\n        code: true,\r\n        status: true,\r\n      },\r\n    });\r\n  } else if (query.clock) {\r\n    return prisma.equipment.findMany({\r\n      where: {\r\n        status: { not: \"ARCHIVED\" },\r\n      },\r\n      select: {\r\n        id: true,\r\n        qrId: true,\r\n        name: true,\r\n        code: true,\r\n        status: true,\r\n      },\r\n    });\r\n  } else {\r\n    return prisma.equipment.findMany();\r\n  }\r\n}\r\n\r\nexport async function getEquipmentMileageService(equipmentId: string) {\r\n  return await prisma.truckingLog.findFirst({\r\n    where: {\r\n      OR: [\r\n        { truckNumber: equipmentId }, // Equipment used as truck (most common for mileage)\r\n        { trailerNumber: equipmentId }, // Equipment used as trailer\r\n        { equipmentId: equipmentId }, // Equipment being hauled\r\n      ],\r\n      endingMileage: {\r\n        not: null, // Only get entries that have an ending mileage recorded\r\n      },\r\n    },\r\n    orderBy: [\r\n      {\r\n        TimeSheet: {\r\n          // Order by creation time if endTime is null, otherwise by endTime\r\n          createdAt: \"desc\",\r\n        },\r\n      },\r\n    ],\r\n    include: {\r\n      Equipment: true,\r\n      TimeSheet: {\r\n        include: {\r\n          User: true,\r\n        },\r\n      },\r\n    },\r\n  });\r\n}\r\n\r\n// Find an equipment by QR code (for QR code uniqueness check)\r\nexport async function getEquipmentByQrId(qrId: string) {\r\n  return await prisma.equipment.findFirst({ where: { qrId } });\r\n}\r\n\r\n// Create equipment (POST)\r\nexport async function createEquipment(data: {\r\n  ownershipType: string;\r\n  createdById: string;\r\n  equipmentTag: string;\r\n  name: string;\r\n  creationReason: string;\r\n  destination?: string;\r\n  qrId: string;\r\n  description?: string;\r\n}) {\r\n  const {\r\n    ownershipType,\r\n    createdById,\r\n    equipmentTag,\r\n    name,\r\n    creationReason,\r\n    destination,\r\n    qrId,\r\n    description = \"\",\r\n  } = data;\r\n\r\n  if (!equipmentTag) {\r\n    throw new Error(\"Please select an equipment tag.\");\r\n  }\r\n\r\n  // Transaction for equipment and hauled\r\n  const result = await prisma.$transaction(async (prisma) => {\r\n    const newEquipment = await prisma.equipment.create({\r\n      data: {\r\n        qrId,\r\n        name,\r\n        status: \"ACTIVE\",\r\n        description,\r\n        creationReason,\r\n        equipmentTag: equipmentTag as EquipmentTags, // Cast to EquipmentTags\r\n        createdById,\r\n        ownershipType: ownershipType as OwnershipType, // Cast to OwnershipType\r\n      },\r\n      include: {\r\n        createdBy: {\r\n          select: {\r\n            firstName: true,\r\n            lastName: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (destination) {\r\n      await prisma.equipmentHauled.create({\r\n        data: {\r\n          equipmentId: newEquipment.id,\r\n          destination,\r\n        },\r\n      });\r\n    }\r\n\r\n    return newEquipment;\r\n  });\r\n\r\n  return result;\r\n}\r\n"],"names":[],"mappings":"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","debug_id":"538ed54e-71da-5d40-9893-c1ddfd2942d2"}