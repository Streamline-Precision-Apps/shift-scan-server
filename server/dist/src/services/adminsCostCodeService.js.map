{"version":3,"file":"adminsCostCodeService.js","sources":["src/services/adminsCostCodeService.ts"],"sourceRoot":"/","sourcesContent":["import type { Prisma } from \"../../generated/prisma/index.js\";\r\nimport prisma from \"../lib/prisma.js\";\r\n\r\nexport async function getCostCodes({\r\n  search,\r\n  page,\r\n  pageSize,\r\n  skip,\r\n}: {\r\n  search: string;\r\n  page: number | undefined;\r\n  pageSize: number | undefined;\r\n  skip: number | undefined;\r\n}) {\r\n  if (search !== \"\") {\r\n    page = undefined;\r\n    pageSize = undefined;\r\n    skip = undefined;\r\n    const totalPages = 1;\r\n    const costCodeSummary = await prisma.costCode.findMany({\r\n      include: {\r\n        CCTags: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n          },\r\n        },\r\n        _count: {\r\n          select: {\r\n            Timesheets: true,\r\n          },\r\n        },\r\n      },\r\n      orderBy: {\r\n        name: \"asc\",\r\n      },\r\n    });\r\n    const total = costCodeSummary.length;\r\n    return {\r\n      costCodes: costCodeSummary,\r\n      total,\r\n      page,\r\n      pageSize,\r\n      totalPages,\r\n    };\r\n  } else {\r\n    page = page || 1;\r\n    pageSize = pageSize || 10;\r\n    const skip = (page - 1) * pageSize;\r\n    const take = pageSize;\r\n    // Fetch total count for pagination\r\n    const total = await prisma.costCode.count();\r\n    const totalPages = Math.ceil(total / pageSize);\r\n    // Fetch only essential fields from cost codes\r\n    const costCodeSummary = await prisma.costCode.findMany({\r\n      skip,\r\n      take,\r\n      include: {\r\n        CCTags: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n          },\r\n        },\r\n        _count: {\r\n          select: {\r\n            Timesheets: true,\r\n          },\r\n        },\r\n      },\r\n      orderBy: {\r\n        name: \"asc\",\r\n      },\r\n    });\r\n    return {\r\n      costCodes: costCodeSummary,\r\n      total,\r\n      page,\r\n      pageSize,\r\n      totalPages,\r\n    };\r\n  }\r\n}\r\n\r\nexport async function getCostCodesById(id: string) {\r\n  return await prisma.costCode.findUnique({\r\n    where: { id },\r\n    include: {\r\n      CCTags: {\r\n        select: {\r\n          id: true,\r\n          name: true,\r\n        },\r\n      },\r\n    },\r\n  });\r\n}\r\n\r\nexport async function getCostCodeSummary() {\r\n  return await prisma.costCode.findMany({\r\n    select: {\r\n      id: true,\r\n      code: true,\r\n      name: true,\r\n      isActive: true,\r\n    },\r\n    orderBy: {\r\n      name: \"asc\",\r\n    },\r\n  });\r\n}\r\n\r\nexport async function createCostCodes(payload: {\r\n  code: string;\r\n  name: string;\r\n  isActive: boolean;\r\n  CCTags: {\r\n    id: string;\r\n    name: string;\r\n  }[];\r\n}) {\r\n  // Validate required fields\r\n  if (!payload.name?.trim()) {\r\n    throw new Error(\"Cost code name is required\");\r\n  }\r\n\r\n  // Check if cost code with the same name already exists\r\n  const existingCostCode = await prisma.costCode.findFirst({\r\n    where: {\r\n      OR: [{ code: payload.code.trim() }, { name: payload.name.trim() }],\r\n    },\r\n  });\r\n\r\n  if (existingCostCode) {\r\n    throw new Error(\"A cost code with this name already exists\");\r\n  }\r\n\r\n  // Create the new cost code\r\n  return await prisma.costCode.create({\r\n    data: {\r\n      code: payload.code.trim(), // Use the code as-is (without #)\r\n      name: payload.name.trim(), // Use the name as-is (already formatted as \"#code name\")\r\n      isActive: payload.isActive,\r\n      CCTags: {\r\n        connect: payload.CCTags?.map((tag) => ({ id: tag.id })) || [],\r\n      },\r\n    },\r\n  });\r\n}\r\n\r\nexport type UpdateCostCodePayload = {\r\n  code?: string;\r\n  name?: string;\r\n  isActive?: boolean;\r\n  CCTags?: { id: string; name?: string }[];\r\n};\r\n\r\nexport async function updateCostCodes(\r\n  id: string,\r\n  payload: UpdateCostCodePayload\r\n) {\r\n  const existingCostCode = await prisma.costCode.findUnique({\r\n    where: { id },\r\n    include: {\r\n      CCTags: {\r\n        select: { id: true, name: true },\r\n      },\r\n    },\r\n  });\r\n\r\n  if (!existingCostCode) {\r\n    throw new Error(\"Cost code not found\");\r\n  }\r\n\r\n  const updateData: Prisma.CostCodeUpdateInput = {};\r\n  if (payload.code !== undefined) {\r\n    updateData.code = payload.code.trim();\r\n  }\r\n  if (payload.name !== undefined) {\r\n    updateData.name = payload.name.trim();\r\n  }\r\n  if (payload.isActive !== undefined) {\r\n    updateData.isActive = payload.isActive;\r\n  }\r\n\r\n  if (payload.CCTags) {\r\n    let cCTagsArray = payload.CCTags;\r\n    // If no tags provided, add the 'All' tag automatically\r\n    if (!Array.isArray(cCTagsArray) || cCTagsArray.length === 0) {\r\n      // Find the 'All' tag in the database\r\n      const allTag = await prisma.cCTag.findFirst({\r\n        where: { name: { equals: \"All\", mode: \"insensitive\" } },\r\n        select: { id: true },\r\n      });\r\n      if (allTag) {\r\n        cCTagsArray = [{ id: allTag.id }];\r\n      }\r\n    }\r\n    updateData.CCTags = {\r\n      set: cCTagsArray.map((tag: { id: string }) => ({ id: tag.id })),\r\n    };\r\n  }\r\n\r\n  return await prisma.costCode.update({\r\n    where: { id },\r\n    data: updateData,\r\n    include: { CCTags: true },\r\n  });\r\n}\r\n\r\nexport async function deleteCostCodes(id: string) {\r\n  const costCodeWithRelations = await prisma.costCode.findUnique({\r\n    where: { id },\r\n    include: {\r\n      Timesheets: true,\r\n      CCTags: true,\r\n    },\r\n  });\r\n\r\n  if (!costCodeWithRelations) {\r\n    throw new Error(\"Cost code not found\");\r\n  }\r\n\r\n  // Check if cost code is in use\r\n  if (costCodeWithRelations.Timesheets.length > 0) {\r\n    throw new Error(\"Cannot delete cost code that is used in timesheets\");\r\n  }\r\n\r\n  // Disconnect any related CCTags before deletion\r\n  if (costCodeWithRelations.CCTags.length > 0) {\r\n    await prisma.costCode.update({\r\n      where: { id },\r\n      data: {\r\n        CCTags: {\r\n          disconnect: costCodeWithRelations.CCTags.map((tag) => ({\r\n            id: tag.id,\r\n          })),\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  // Delete the cost code\r\n  await prisma.costCode.delete({\r\n    where: { id },\r\n  });\r\n}\r\n\r\nexport async function restoreCostCodes(id: string) {\r\n  return await prisma.costCode.update({\r\n    where: { id },\r\n    data: {\r\n      isActive: true,\r\n    },\r\n  });\r\n}\r\n\r\nexport async function archiveCostCodes(id: string) {\r\n  return await prisma.costCode.update({\r\n    where: { id },\r\n    data: {\r\n      isActive: false,\r\n    },\r\n  });\r\n}\r\n"],"names":[],"mappings":"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","debug_id":"d1ae0271-a8e5-5b65-bf14-74cb5e0f320e"}