{"version":3,"file":"adminsCostCodeService.js","sources":["src/services/adminsCostCodeService.ts"],"sourceRoot":"/","sourcesContent":["import type { Prisma } from \"../../generated/prisma/index.js\";\nimport prisma from \"../lib/prisma.js\";\n\nexport async function getCostCodes({\n  search,\n  page,\n  pageSize,\n  skip,\n}: {\n  search: string;\n  page: number | undefined;\n  pageSize: number | undefined;\n  skip: number | undefined;\n}) {\n  if (search !== \"\") {\n    page = undefined;\n    pageSize = undefined;\n    skip = undefined;\n    const totalPages = 1;\n    const costCodeSummary = await prisma.costCode.findMany({\n      include: {\n        CCTags: {\n          select: {\n            id: true,\n            name: true,\n          },\n        },\n        _count: {\n          select: {\n            Timesheets: true,\n          },\n        },\n      },\n      orderBy: {\n        name: \"asc\",\n      },\n    });\n    const total = costCodeSummary.length;\n    return {\n      costCodes: costCodeSummary,\n      total,\n      page,\n      pageSize,\n      totalPages,\n    };\n  } else {\n    page = page || 1;\n    pageSize = pageSize || 10;\n    const skip = (page - 1) * pageSize;\n    const take = pageSize;\n    // Fetch total count for pagination\n    const total = await prisma.costCode.count();\n    const totalPages = Math.ceil(total / pageSize);\n    // Fetch only essential fields from cost codes\n    const costCodeSummary = await prisma.costCode.findMany({\n      skip,\n      take,\n      include: {\n        CCTags: {\n          select: {\n            id: true,\n            name: true,\n          },\n        },\n        _count: {\n          select: {\n            Timesheets: true,\n          },\n        },\n      },\n      orderBy: {\n        name: \"asc\",\n      },\n    });\n    return {\n      costCodes: costCodeSummary,\n      total,\n      page,\n      pageSize,\n      totalPages,\n    };\n  }\n}\n\nexport async function getCostCodesById(id: string) {\n  return await prisma.costCode.findUnique({\n    where: { id },\n    include: {\n      CCTags: {\n        select: {\n          id: true,\n          name: true,\n        },\n      },\n    },\n  });\n}\n\nexport async function getCostCodeSummary() {\n  return await prisma.costCode.findMany({\n    select: {\n      id: true,\n      code: true,\n      name: true,\n      isActive: true,\n    },\n    orderBy: {\n      name: \"asc\",\n    },\n  });\n}\n\nexport async function createCostCodes(payload: {\n  code: string;\n  name: string;\n  isActive: boolean;\n  CCTags: {\n    id: string;\n    name: string;\n  }[];\n}) {\n  // Validate required fields\n  if (!payload.name?.trim()) {\n    throw new Error(\"Cost code name is required\");\n  }\n\n  // Check if cost code with the same name already exists\n  const existingCostCode = await prisma.costCode.findFirst({\n    where: {\n      OR: [{ code: payload.code.trim() }, { name: payload.name.trim() }],\n    },\n  });\n\n  if (existingCostCode) {\n    throw new Error(\"A cost code with this name already exists\");\n  }\n\n  // Create the new cost code\n  return await prisma.costCode.create({\n    data: {\n      code: payload.code.trim(), // Use the code as-is (without #)\n      name: payload.name.trim(), // Use the name as-is (already formatted as \"#code name\")\n      isActive: payload.isActive,\n      CCTags: {\n        connect: payload.CCTags?.map((tag) => ({ id: tag.id })) || [],\n      },\n    },\n  });\n}\n\nexport type UpdateCostCodePayload = {\n  code?: string;\n  name?: string;\n  isActive?: boolean;\n  CCTags?: { id: string; name?: string }[];\n};\n\nexport async function updateCostCodes(\n  id: string,\n  payload: UpdateCostCodePayload\n) {\n  const existingCostCode = await prisma.costCode.findUnique({\n    where: { id },\n    include: {\n      CCTags: {\n        select: { id: true, name: true },\n      },\n    },\n  });\n\n  if (!existingCostCode) {\n    throw new Error(\"Cost code not found\");\n  }\n\n  const updateData: Prisma.CostCodeUpdateInput = {};\n  if (payload.code !== undefined) {\n    updateData.code = payload.code.trim();\n  }\n  if (payload.name !== undefined) {\n    updateData.name = payload.name.trim();\n  }\n  if (payload.isActive !== undefined) {\n    updateData.isActive = payload.isActive;\n  }\n\n  if (payload.CCTags) {\n    let cCTagsArray = payload.CCTags;\n    // If no tags provided, add the 'All' tag automatically\n    if (!Array.isArray(cCTagsArray) || cCTagsArray.length === 0) {\n      // Find the 'All' tag in the database\n      const allTag = await prisma.cCTag.findFirst({\n        where: { name: { equals: \"All\", mode: \"insensitive\" } },\n        select: { id: true },\n      });\n      if (allTag) {\n        cCTagsArray = [{ id: allTag.id }];\n      }\n    }\n    updateData.CCTags = {\n      set: cCTagsArray.map((tag: { id: string }) => ({ id: tag.id })),\n    };\n  }\n\n  return await prisma.costCode.update({\n    where: { id },\n    data: updateData,\n    include: { CCTags: true },\n  });\n}\n\nexport async function deleteCostCodes(id: string) {\n  const costCodeWithRelations = await prisma.costCode.findUnique({\n    where: { id },\n    include: {\n      Timesheets: true,\n      CCTags: true,\n    },\n  });\n\n  if (!costCodeWithRelations) {\n    throw new Error(\"Cost code not found\");\n  }\n\n  // Check if cost code is in use\n  if (costCodeWithRelations.Timesheets.length > 0) {\n    throw new Error(\"Cannot delete cost code that is used in timesheets\");\n  }\n\n  // Disconnect any related CCTags before deletion\n  if (costCodeWithRelations.CCTags.length > 0) {\n    await prisma.costCode.update({\n      where: { id },\n      data: {\n        CCTags: {\n          disconnect: costCodeWithRelations.CCTags.map((tag) => ({\n            id: tag.id,\n          })),\n        },\n      },\n    });\n  }\n\n  // Delete the cost code\n  await prisma.costCode.delete({\n    where: { id },\n  });\n}\n\nexport async function restoreCostCodes(id: string) {\n  return await prisma.costCode.update({\n    where: { id },\n    data: {\n      isActive: true,\n    },\n  });\n}\n\nexport async function archiveCostCodes(id: string) {\n  return await prisma.costCode.update({\n    where: { id },\n    data: {\n      isActive: false,\n    },\n  });\n}\n"],"names":[],"mappings":"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","debug_id":"78e73c91-52e0-598a-a574-8b731ae3101b"}