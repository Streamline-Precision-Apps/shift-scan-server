{"version":3,"file":"index.js","sources":["src/index.ts"],"sourceRoot":"/","sourcesContent":["import \"./instrument.mjs\";\r\nimport * as Sentry from \"@sentry/node\";\r\nimport express from \"express\";\r\nimport cors from \"cors\";\r\nimport helmet from \"helmet\";\r\nimport morgan from \"morgan\";\r\nimport cookieParser from \"cookie-parser\";\r\nimport swaggerUi from \"swagger-ui-express\";\r\nimport prisma from \"./lib/prisma.js\";\r\nimport config from \"./lib/config.js\";\r\nimport { swaggerSpec } from \"./lib/swagger.js\";\r\nimport apiRoutes from \"./routes/index.js\";\r\nimport {\r\n  errorHandler,\r\n  notFoundHandler,\r\n  validateJsonMiddleware,\r\n} from \"./middleware/errorMiddleware.js\";\r\nimport authRoutes from \"./routes/authRoutes.js\";\r\n\r\nasync function main() {\r\n  console.log(\"ðŸš€ Server starting...\");\r\n\r\n  try {\r\n    // Test database connection\r\n    await prisma.$connect();\r\n    console.log(\"âœ… Database connected successfully\");\r\n\r\n    // Create Express app\r\n    const app = express();\r\n\r\n    // Security middleware\r\n    app.use(helmet());\r\n\r\n    // CORS middleware\r\n    app.use(\r\n      cors({\r\n        origin: process.env.CORS_ORIGIN || \"http://localhost:3000\",\r\n        credentials: true,\r\n        methods: [\"GET\", \"POST\", \"PUT\", \"DELETE\", \"OPTIONS\"],\r\n        allowedHeaders: [\"Content-Type\", \"Authorization\"],\r\n        exposedHeaders: [\"Set-Cookie\"],\r\n      })\r\n    );\r\n\r\n    // Cookie parser (required to read httpOnly cookies)\r\n    app.use(cookieParser());\r\n\r\n    // Logging middleware\r\n    app.use(morgan(\"combined\"));\r\n\r\n    // CORS Origin logging middleware\r\n    app.use((req, res, next) => {\r\n      const origin = req.headers.origin || req.headers.referer || \"unknown\";\r\n      const method = req.method;\r\n      const url = req.url;\r\n      console.log(\r\n        `[CORS REQUEST] Origin: ${origin} | Method: ${method} | URL: ${url}`\r\n      );\r\n      next();\r\n    });\r\n\r\n    // Body parsing middleware\r\n    app.use(express.json({ limit: \"10mb\" }));\r\n    app.use(express.urlencoded({ extended: true, limit: \"10mb\" }));\r\n\r\n    // JSON validation middleware\r\n    app.use(validateJsonMiddleware);\r\n\r\n    // Auth middleware\r\n    app.use(\"/auth\", authRoutes);\r\n\r\n    app.use(\"/api-docs\", swaggerUi.serve, swaggerUi.setup(swaggerSpec));\r\n\r\n    // Root route\r\n    app.get(\"/\", function rootHandler(req, res) {\r\n      res.end(\"Welcome to the Shift Scan API!\");\r\n    });\r\n\r\n    // API routes\r\n    app.use(\"/api\", apiRoutes);\r\n\r\n    // The error handler must be registered before any other error middleware and after all controllers\r\n    Sentry.setupExpressErrorHandler(app);\r\n\r\n    // 404 handler\r\n    app.use(notFoundHandler);\r\n\r\n    // Error handling middleware (must be last)\r\n    app.use(errorHandler);\r\n\r\n    const PORT = parseInt(process.env.PORT || \"8080\", 10) || 8080;\r\n\r\n    // Start server\r\n    const server = app.listen(PORT, \"0.0.0.0\", () => {\r\n      console.log(`ðŸŒŸ Server is running on port ${PORT}`);\r\n      console.log(`ðŸŒ Accessible at http://0.0.0.0:${PORT}`);\r\n      if (process.env.NODE_ENV !== \"production\") {\r\n        console.log(`ðŸ“± Accessible from test at http://192.168.1.102:${PORT}`);\r\n        console.log(\r\n          `ðŸ“– API documentation available at http://localhost:${PORT}/api-docs`\r\n        );\r\n      }\r\n    });\r\n\r\n    // Handle server shutdown\r\n    const gracefulShutdown = async (signal: string) => {\r\n      console.log(`\\nðŸ”„ Received ${signal}, shutting down gracefully...`);\r\n      server.close(async () => {\r\n        await prisma.$disconnect();\r\n        console.log(\"âœ… Server closed successfully\");\r\n        process.exit(0);\r\n      });\r\n    };\r\n\r\n    process.on(\"SIGINT\", () => gracefulShutdown(\"SIGINT\"));\r\n    process.on(\"SIGTERM\", () => gracefulShutdown(\"SIGTERM\"));\r\n  } catch (error) {\r\n    console.error(\"âŒ Failed to start server:\", error);\r\n    await prisma.$disconnect();\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nmain().catch(async (error) => {\r\n  console.error(\"ðŸ’¥ Server crashed:\", error);\r\n  await prisma.$disconnect();\r\n  process.exit(1);\r\n});\r\n"],"names":[],"mappings":"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","debug_id":"4e05e8a7-a971-5c45-bb6b-adf2a0fce247"}