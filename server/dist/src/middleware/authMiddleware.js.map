{"version":3,"file":"authMiddleware.js","sources":["src/middleware/authMiddleware.ts"],"sourceRoot":"/","sourcesContent":["import express from \"express\";\r\nimport jwt from \"jsonwebtoken\";\r\nimport config from \"../lib/config.js\";\r\nimport type { JwtUserPayload } from \"../lib/jwt.js\";\r\n\r\nexport interface AuthenticatedRequest extends express.Request {\r\n  user?: JwtUserPayload;\r\n}\r\n\r\nexport function verifyToken(\r\n  req: AuthenticatedRequest,\r\n  res: express.Response,\r\n  next: express.NextFunction\r\n) {\r\n  // Check Authorization header first (Bearer <token>) then fall back to cookie\r\n  const authHeader = req.headers[\"authorization\"] as string | undefined;\r\n  let token: string | undefined;\r\n\r\n  if (authHeader && authHeader.startsWith(\"Bearer \")) {\r\n    token = authHeader.split(\" \")[1];\r\n  } else if ((req as any).cookies && (req as any).cookies.token) {\r\n    token = (req as any).cookies.token;\r\n  }\r\n\r\n  if (!token) return res.status(401).json({ message: \"No token provided\" });\r\n\r\n  // Allow build token for static export/build processes\r\n  if (process.env.BUILD_TOKEN && token === process.env.BUILD_TOKEN) {\r\n    req.user = { id: \"build-script\" } as JwtUserPayload; // dummy user info\r\n    return next();\r\n  }\r\n\r\n  try {\r\n    const decoded = jwt.verify(token, config.jwtSecret) as JwtUserPayload;\r\n    req.user = decoded;\r\n    next();\r\n  } catch (err) {\r\n    res.status(403).json({ message: \"Invalid or expired token\" });\r\n  }\r\n}\r\n\r\n// middleware/authMiddleware.js\r\nexport function authorizeRoles(\r\n  ...allowedRoles: (\"USER\" | \"MANAGER\" | \"ADMIN\" | \"SUPERADMIN\")[]\r\n) {\r\n  return (\r\n    req: AuthenticatedRequest,\r\n    res: express.Response,\r\n    next: express.NextFunction\r\n  ) => {\r\n    if (!req.user) {\r\n      return res.status(401).json({ message: \"Not authenticated\" });\r\n    }\r\n\r\n    // Permission check removed: JWT only contains user ID now\r\n\r\n    next();\r\n  };\r\n}\r\n"],"names":[],"mappings":";;AAAA,OAAO,OAAO,MAAM,SAAS,CAAC;AAC9B,OAAO,GAAG,MAAM,cAAc,CAAC;AAC/B,OAAO,MAAM,MAAM,kBAAkB,CAAC;AAOtC,MAAM,UAAU,WAAW,CACzB,GAAyB,EACzB,GAAqB,EACrB,IAA0B;IAE1B,6EAA6E;IAC7E,MAAM,UAAU,GAAG,GAAG,CAAC,OAAO,CAAC,eAAe,CAAuB,CAAC;IACtE,IAAI,KAAyB,CAAC;IAE9B,IAAI,UAAU,IAAI,UAAU,CAAC,UAAU,CAAC,SAAS,CAAC,EAAE,CAAC;QACnD,KAAK,GAAG,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;IACnC,CAAC;SAAM,IAAK,GAAW,CAAC,OAAO,IAAK,GAAW,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC;QAC9D,KAAK,GAAI,GAAW,CAAC,OAAO,CAAC,KAAK,CAAC;IACrC,CAAC;IAED,IAAI,CAAC,KAAK;QAAE,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,mBAAmB,EAAE,CAAC,CAAC;IAE1E,sDAAsD;IACtD,IAAI,OAAO,CAAC,GAAG,CAAC,WAAW,IAAI,KAAK,KAAK,OAAO,CAAC,GAAG,CAAC,WAAW,EAAE,CAAC;QACjE,GAAG,CAAC,IAAI,GAAG,EAAE,EAAE,EAAE,cAAc,EAAoB,CAAC,CAAC,kBAAkB;QACvE,OAAO,IAAI,EAAE,CAAC;IAChB,CAAC;IAED,IAAI,CAAC;QACH,MAAM,OAAO,GAAG,GAAG,CAAC,MAAM,CAAC,KAAK,EAAE,MAAM,CAAC,SAAS,CAAmB,CAAC;QACtE,GAAG,CAAC,IAAI,GAAG,OAAO,CAAC;QACnB,IAAI,EAAE,CAAC;IACT,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,0BAA0B,EAAE,CAAC,CAAC;IAChE,CAAC;AACH,CAAC;AAED,+BAA+B;AAC/B,MAAM,UAAU,cAAc,CAC5B,GAAG,YAA6D;IAEhE,OAAO,CACL,GAAyB,EACzB,GAAqB,EACrB,IAA0B,EAC1B,EAAE;QACF,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,CAAC;YACd,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,mBAAmB,EAAE,CAAC,CAAC;QAChE,CAAC;QAED,0DAA0D;QAE1D,IAAI,EAAE,CAAC;IACT,CAAC,CAAC;AACJ,CAAC","debug_id":"78a08668-9e18-572f-98b4-50debb8e2cd4"}