{"version":3,"file":"authController.js","sourceRoot":"/","sources":["src/controllers/authController.ts"],"names":[],"mappings":"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","sourcesContent":["import express from \"express\";\nimport { compare } from \"bcryptjs\";\nimport jwt from \"jsonwebtoken\";\nimport dotenv from \"dotenv\";\nimport prisma from \"../lib/prisma.js\";\nimport config from \"../lib/config.js\";\n\ndotenv.config();\n\ninterface JwtUserPayload {\n  id: string;\n}\n\nexport const loginUser = async (\n  req: express.Request,\n  res: express.Response\n) => {\n  const { username, password } = req.body as {\n    username: string;\n    password: string;\n  };\n\n  // 1. Check for missing credentials\n  if (!username || !password)\n    return res.status(400).json({ error: \"Missing credentials\" });\n\n  try {\n    // 2. Find user by username\n    const user = await prisma.user.findUnique({ where: { username } });\n    if (!user) return res.status(401).json({ error: \"Invalid credentials\" });\n\n    // 3. Verify password\n    const validPassword = await compare(password, user.password);\n    if (!validPassword)\n      return res.status(401).json({ error: \"Invalid credentials\" });\n\n    const payload: JwtUserPayload = {\n      id: user.id,\n    };\n    // create JWT token\n    const token = jwt.sign(payload, config.jwtSecret, {\n      expiresIn: config.jwtExpiration, // 30 days\n    });\n\n    // set token in httpOnly cookie so client can send it with requests\n    const cookieOptions = {\n      httpOnly: true,\n      secure: process.env.NODE_ENV === \"production\",\n      sameSite: \"none\", // necessary for cross-site cookies with credentials: 'include'\n      maxAge: config.jwtExpiration * 1000, // convert seconds -> ms\n    } as const;\n\n    // name the cookie `token`; this allows the middleware to read it as a fallback\n    res.cookie(\"session\", token, cookieOptions);\n\n    // Return simplified user object with ID (full user will be fetched via /api/v1/init)\n    return res.status(200).json({\n      message: \"Login successful\",\n      token,\n      user: {\n        id: user.id,\n        accountSetup: user.accountSetup,\n      },\n    });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ error: \"Internal server error\" });\n  }\n};\n\nexport const signOutUser = async (\n  req: express.Request,\n  res: express.Response\n) => {\n  try {\n    // Get all cookies from the request\n    const cookies = req.cookies || {};\n    // Clear all cookies except 'locale'\n    Object.keys(cookies).forEach((cookieName) => {\n      if (cookieName !== \"locale\") {\n        res.clearCookie(cookieName, {\n          httpOnly: true,\n          secure: process.env.NODE_ENV === \"production\",\n          sameSite: \"none\",\n        });\n      }\n    });\n    return res.status(200).json({ message: \"Sign out successful\" });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ error: \"Internal server error\" });\n  }\n};\n"]}