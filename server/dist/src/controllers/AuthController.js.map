{"version":3,"file":"AuthController.js","sources":["src/controllers/AuthController.ts"],"sourceRoot":"/","sourcesContent":["import express from \"express\";\r\nimport { compare } from \"bcryptjs\";\r\nimport jwt from \"jsonwebtoken\";\r\nimport dotenv from \"dotenv\";\r\nimport prisma from \"../lib/prisma.js\";\r\nimport config from \"../lib/config.js\";\r\n\r\ndotenv.config();\r\n\r\ninterface JwtUserPayload {\r\n  id: string;\r\n}\r\n\r\nexport const loginUser = async (\r\n  req: express.Request,\r\n  res: express.Response\r\n) => {\r\n  const { username, password } = req.body as {\r\n    username: string;\r\n    password: string;\r\n  };\r\n\r\n  // 1. Check for missing credentials\r\n  if (!username || !password)\r\n    return res.status(400).json({ error: \"Missing credentials\" });\r\n\r\n  try {\r\n    // 2. Find user by username\r\n    const user = await prisma.user.findUnique({ where: { username } });\r\n    if (!user) return res.status(401).json({ error: \"Invalid credentials\" });\r\n\r\n    // 3. Verify password\r\n    const validPassword = await compare(password, user.password);\r\n    if (!validPassword)\r\n      return res.status(401).json({ error: \"Invalid credentials\" });\r\n\r\n    const payload: JwtUserPayload = {\r\n      id: user.id,\r\n    };\r\n    // create JWT token\r\n    const token = jwt.sign(payload, config.jwtSecret, {\r\n      expiresIn: config.jwtExpiration, // 30 days\r\n    });\r\n\r\n    // set token in httpOnly cookie so client can send it with requests\r\n    const cookieOptions = {\r\n      httpOnly: true,\r\n      secure: process.env.NODE_ENV === \"production\",\r\n      sameSite: \"none\", // necessary for cross-site cookies with credentials: 'include'\r\n      maxAge: config.jwtExpiration * 1000, // convert seconds -> ms\r\n    } as const;\r\n\r\n    // name the cookie `token`; this allows the middleware to read it as a fallback\r\n    res.cookie(\"session\", token, cookieOptions);\r\n\r\n    // Return simplified user object with ID (full user will be fetched via /api/v1/init)\r\n    return res.status(200).json({\r\n      message: \"Login successful\",\r\n      token,\r\n      user: {\r\n        id: user.id,\r\n        accountSetup: user.accountSetup,\r\n      },\r\n    });\r\n  } catch (err) {\r\n    console.error(err);\r\n    return res.status(500).json({ error: \"Internal server error\" });\r\n  }\r\n};\r\n\r\nexport const signOutUser = async (\r\n  req: express.Request,\r\n  res: express.Response\r\n) => {\r\n  try {\r\n    // Get all cookies from the request\r\n    const cookies = req.cookies || {};\r\n    // Clear all cookies except 'locale'\r\n    Object.keys(cookies).forEach((cookieName) => {\r\n      if (cookieName !== \"locale\") {\r\n        res.clearCookie(cookieName, {\r\n          httpOnly: true,\r\n          secure: process.env.NODE_ENV === \"production\",\r\n          sameSite: \"none\",\r\n        });\r\n      }\r\n    });\r\n    return res.status(200).json({ message: \"Sign out successful\" });\r\n  } catch (err) {\r\n    console.error(err);\r\n    return res.status(500).json({ error: \"Internal server error\" });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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","debug_id":"6d47b86f-2be1-5441-93b7-df4164dd1a90"}