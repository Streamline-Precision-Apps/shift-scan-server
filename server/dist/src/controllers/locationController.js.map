{"version":3,"file":"locationController.js","sources":["src/controllers/locationController.ts"],"sourceRoot":"/","sourcesContent":["import type { AuthenticatedRequest } from \"../middleware/authMiddleware.js\";\r\nimport type { Request, Response } from \"express\";\r\n\r\nimport {\r\n  fetchLatestLocation,\r\n  fetchLocationHistory,\r\n  fetchAllUsersLatestLocations,\r\n  saveUserClockInLocation,\r\n  saveUserClockOutLocation,\r\n  validateLocationPayload,\r\n} from \"../services/locationService.js\";\r\n\r\n// get the latest location for a user\r\nexport async function getUserLocations(\r\n  req: AuthenticatedRequest,\r\n  res: Response\r\n) {\r\n  const userId = req.user?.id || req.params.userId;\r\n  if (!userId) {\r\n    return res.status(400).json({ error: \"Missing userId\" });\r\n  }\r\n  try {\r\n    // Parse date from query parameter, default to today\r\n    const dateParam = req.query.date as string | undefined;\r\n    const date = dateParam ? new Date(dateParam) : new Date();\r\n\r\n    const location = await fetchLatestLocation(userId, date);\r\n    if (!location) {\r\n      return res.status(404).json({ error: \"No location found for user\" });\r\n    }\r\n    return res.json(location);\r\n  } catch (err) {\r\n    console.error(\"Error fetching user location:\", err);\r\n    return res.status(500).json({ error: \"Internal server error\" });\r\n  }\r\n}\r\n\r\n// Get all users' current locations for map view\r\nexport async function getAllUsersLocations(\r\n  req: AuthenticatedRequest,\r\n  res: Response\r\n) {\r\n  try {\r\n    // Parse date from query parameter, default to today\r\n    const dateParam = req.query.date as string | undefined;\r\n    const date = dateParam ? new Date(dateParam) : new Date();\r\n\r\n    const locations = await fetchAllUsersLatestLocations(date);\r\n    return res.json(locations);\r\n  } catch (err) {\r\n    console.error(\"Error fetching all users locations:\", err);\r\n    return res.status(500).json({ error: \"Internal server error\" });\r\n  }\r\n}\r\n\r\n// fetch all locations for a user (for history)\r\nexport async function getUserLocationHistory(req: Request, res: Response) {\r\n  const userId = req.params.userId;\r\n  if (!userId) {\r\n    return res.status(400).json({ error: \"Missing userId\" });\r\n  }\r\n  try {\r\n    // Parse date from query parameter, default to today\r\n    const dateParam = req.query.date as string | undefined;\r\n    const date = dateParam ? new Date(dateParam) : new Date();\r\n\r\n    const locations = await fetchLocationHistory(userId, date);\r\n    return res.json(locations);\r\n  } catch (err) {\r\n    console.error(\"Error fetching user location history:\", err);\r\n    return res.status(500).json({ error: \"Internal server error\" });\r\n  }\r\n}\r\n\r\n// Handle POST location from client\r\nexport async function postUserLocation(\r\n  req: AuthenticatedRequest,\r\n  res: Response\r\n) {\r\n  // Extract userId, sessionId, and location data from request body\r\n  const { userId, sessionId, coords, device } = req.body;\r\n  const clockType = req.query.clockType as string | undefined;\r\n\r\n  if (!userId || !sessionId) {\r\n    return res.status(400).json({ error: \"Missing userId or sessionId\" });\r\n  }\r\n\r\n  if (!clockType || (clockType !== \"clockIn\" && clockType !== \"clockOut\")) {\r\n    return res.status(400).json({\r\n      error:\r\n        \"Missing or invalid clockType query parameter (must be 'clockIn' or 'clockOut')\",\r\n    });\r\n  }\r\n\r\n  // For clockIn, coords are required and must be valid\r\n  if (clockType === \"clockIn\") {\r\n    if (!coords) {\r\n      return res.status(400).json({ error: \"Missing coordinates for clockIn\" });\r\n    }\r\n    const validationError = validateLocationPayload({ coords });\r\n    if (validationError) {\r\n      return res.status(400).json({ error: validationError });\r\n    }\r\n  }\r\n\r\n  try {\r\n    if (clockType === \"clockIn\") {\r\n      await saveUserClockInLocation(\r\n        userId,\r\n        parseInt(sessionId),\r\n        coords,\r\n        device\r\n      );\r\n    } else if (clockType === \"clockOut\") {\r\n      // For clockOut, coords are optional; always update session endTime\r\n      await saveUserClockOutLocation(\r\n        userId,\r\n        parseInt(sessionId),\r\n        coords,\r\n        device\r\n      );\r\n    }\r\n    return res.status(201).json({ success: true });\r\n  } catch (err) {\r\n    console.error(\"Error posting user location:\", err);\r\n    return res.status(500).json({ error: \"Internal server error\" });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debug_id":"89138149-419e-50f9-a15b-2ff22d02cf45"}