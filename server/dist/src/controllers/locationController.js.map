{"version":3,"file":"locationController.js","sources":["src/controllers/locationController.ts"],"sourceRoot":"/","sourcesContent":["import type { AuthenticatedRequest } from \"../middleware/authMiddleware.js\";\nimport type { Request, Response } from \"express\";\n\nimport {\n  fetchLatestLocation,\n  fetchLocationHistory,\n  fetchAllUsersLatestLocations,\n  saveUserClockInLocation,\n  saveUserClockOutLocation,\n  validateLocationPayload,\n} from \"../services/locationService.js\";\n\n// get the latest location for a user\nexport async function getUserLocations(\n  req: AuthenticatedRequest,\n  res: Response\n) {\n  const userId = req.user?.id || req.params.userId;\n  if (!userId) {\n    return res.status(400).json({ error: \"Missing userId\" });\n  }\n  try {\n    // Parse date from query parameter, default to today\n    const dateParam = req.query.date as string | undefined;\n    const date = dateParam ? new Date(dateParam) : new Date();\n\n    const location = await fetchLatestLocation(userId, date);\n    if (!location) {\n      return res.status(404).json({ error: \"No location found for user\" });\n    }\n    return res.json(location);\n  } catch (err) {\n    console.error(\"Error fetching user location:\", err);\n    return res.status(500).json({ error: \"Internal server error\" });\n  }\n}\n\n// Get all users' current locations for map view\nexport async function getAllUsersLocations(\n  req: AuthenticatedRequest,\n  res: Response\n) {\n  try {\n    // Parse date from query parameter, default to today\n    const dateParam = req.query.date as string | undefined;\n    const date = dateParam ? new Date(dateParam) : new Date();\n\n    const locations = await fetchAllUsersLatestLocations(date);\n    return res.json(locations);\n  } catch (err) {\n    console.error(\"Error fetching all users locations:\", err);\n    return res.status(500).json({ error: \"Internal server error\" });\n  }\n}\n\n// fetch all locations for a user (for history)\nexport async function getUserLocationHistory(req: Request, res: Response) {\n  const userId = req.params.userId;\n  if (!userId) {\n    return res.status(400).json({ error: \"Missing userId\" });\n  }\n  try {\n    // Parse date from query parameter, default to today\n    const dateParam = req.query.date as string | undefined;\n    const date = dateParam ? new Date(dateParam) : new Date();\n\n    const locations = await fetchLocationHistory(userId, date);\n    return res.json(locations);\n  } catch (err) {\n    console.error(\"Error fetching user location history:\", err);\n    return res.status(500).json({ error: \"Internal server error\" });\n  }\n}\n\n// Handle POST location from client\nexport async function postUserLocation(\n  req: AuthenticatedRequest,\n  res: Response\n) {\n  // Extract userId, sessionId, and location data from request body\n  const { userId, sessionId, coords, device } = req.body;\n  const clockType = req.query.clockType as string | undefined;\n\n  if (!userId || !sessionId) {\n    return res.status(400).json({ error: \"Missing userId or sessionId\" });\n  }\n\n  if (!clockType || (clockType !== \"clockIn\" && clockType !== \"clockOut\")) {\n    return res.status(400).json({\n      error:\n        \"Missing or invalid clockType query parameter (must be 'clockIn' or 'clockOut')\",\n    });\n  }\n\n  // For clockIn, coords are required and must be valid\n  if (clockType === \"clockIn\") {\n    if (!coords) {\n      return res.status(400).json({ error: \"Missing coordinates for clockIn\" });\n    }\n    const validationError = validateLocationPayload({ coords });\n    if (validationError) {\n      return res.status(400).json({ error: validationError });\n    }\n  }\n\n  try {\n    if (clockType === \"clockIn\") {\n      await saveUserClockInLocation(\n        userId,\n        parseInt(sessionId),\n        coords,\n        device\n      );\n    } else if (clockType === \"clockOut\") {\n      // For clockOut, coords are optional; always update session endTime\n      await saveUserClockOutLocation(\n        userId,\n        parseInt(sessionId),\n        coords,\n        device\n      );\n    }\n    return res.status(201).json({ success: true });\n  } catch (err) {\n    console.error(\"Error posting user location:\", err);\n    return res.status(500).json({ error: \"Internal server error\" });\n  }\n}\n"],"names":[],"mappings":"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","debug_id":"ef653560-97c9-5717-b43c-6648577fcba3"}